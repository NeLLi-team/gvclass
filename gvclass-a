#!/usr/bin/env python3
"""Wrapper to run the published GVClass Apptainer image with minimal typing."""

import argparse
import subprocess
from pathlib import Path

DEFAULT_IMAGE = "library://nelligroup-jgi/gvclass/gvclass:1.1.1"


def run_container(
    query: Path,
    output: Path,
    threads: int,
    image: str,
    tree_method: str = None,
    mode_fast: bool = None,
    max_workers: int = None,
) -> int:
    query_abs = query.resolve()
    output_abs = output.resolve()

    if not query_abs.exists():
        raise SystemExit(f"Input directory not found: {query_abs}")

    output_abs.mkdir(parents=True, exist_ok=True)

    cmd = [
        "apptainer",
        "run",
        "-B",
        f"{query_abs}:/input",
        "-B",
        f"{output_abs}:/output",
        image,
        "/input",
        "-o",
        "/output",
        "--threads",
        str(threads),
    ]

    # Add optional flags
    if tree_method:
        cmd.extend(["--tree-method", tree_method])
    if mode_fast is not None:
        cmd.append("--mode-fast" if mode_fast else "--no-mode-fast")
    if max_workers:
        cmd.extend(["-j", str(max_workers)])

    return subprocess.call(cmd)


def main() -> None:
    parser = argparse.ArgumentParser(
        description="Convenience wrapper for running GVClass via Apptainer"
    )
    parser.add_argument("query_dir", help="Directory containing FASTA files to classify")
    parser.add_argument(
        "output_dir",
        nargs="?",
        default=None,
        help="Directory for GVClass results (default: <query_dir>_results)",
    )
    parser.add_argument(
        "-t",
        "--threads",
        type=int,
        default=16,
        help="Total threads to allocate (default: 16)",
    )
    parser.add_argument(
        "-j",
        "--max-workers",
        type=int,
        default=None,
        help="Maximum parallel workers (default: auto-calculated)",
    )
    parser.add_argument(
        "--tree-method",
        choices=["fasttree", "iqtree"],
        default=None,
        help="Tree building method (default: fasttree)",
    )
    parser.add_argument(
        "--mode-fast",
        action="store_true",
        default=None,
        help="Enable fast mode - skip order-level markers for faster analysis",
    )
    parser.add_argument(
        "--no-mode-fast",
        action="store_false",
        dest="mode_fast",
        help="Disable fast mode - process all markers (more accurate)",
    )
    parser.add_argument(
        "--image",
        default=DEFAULT_IMAGE,
        help="Apptainer image URI or path (default: %(default)s)",
    )

    args = parser.parse_args()

    query_path = Path(args.query_dir)
    if args.output_dir:
        output_path = Path(args.output_dir)
    else:
        output_path = query_path.with_name(f"{query_path.name}_results")

    rc = run_container(
        query_path,
        output_path,
        args.threads,
        args.image,
        tree_method=args.tree_method,
        mode_fast=args.mode_fast,
        max_workers=args.max_workers,
    )
    raise SystemExit(rc)


if __name__ == "__main__":
    main()
